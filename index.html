<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="robots" content="noindex">
  <title>MDict Online</title>
  
  <style>
    /* --- å…¨å±€é‡ç½® --- */
    :root {
      --primary: #007AFF;
      --bg-body: #F5F5F7;
      --bg-card: #FFFFFF;
      --text-main: #1D1D1F;
      --text-sub: #86868B;
      --border: #E5E5EA;
      --radius: 18px;
      --shadow: 0 4px 20px rgba(0,0,0,0.06);
    }
    
    * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

    body { 
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, sans-serif; 
      background-color: var(--bg-body); 
      color: var(--text-main);
      margin: 0; padding: 20px; 
      display: flex; justify-content: center; min-height: 100vh;
    }

    /* --- ä¸»å¡ç‰‡å®¹å™¨ --- */
    .app-card {
      width: 100%; max-width: 680px;
      background: var(--bg-card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      display: flex; flex-direction: column;
      height: 90vh; /* é€‚é…ç§»åŠ¨ç«¯ */
      overflow: hidden;
    }

    /* --- å¤´éƒ¨åŒºåŸŸ --- */
    header {
      padding: 24px 24px 16px;
      text-align: center;
      border-bottom: 1px solid var(--border);
      background: rgba(255,255,255,0.9);
      backdrop-filter: blur(10px);
      z-index: 10;
    }

    h2 { 
      margin: 0 0 12px 0; 
      font-size: 18px; 
      font-weight: 600; 
      color: var(--text-main); 
    }

    /* --- çŠ¶æ€èƒ¶å›Š --- */
    #status-area { 
      display: inline-block;
      padding: 6px 16px;
      background: #E5E5EA;
      color: var(--text-sub);
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
      transition: 0.3s;
    }
    /* æˆåŠŸçŠ¶æ€æ ·å¼ (JSä¼šåŠ¨æ€æ·»åŠ ) */
    #status-area.success { background: #34C759; color: white; }
    #status-area.error { background: #FF3B30; color: white; }

    /* --- æœç´¢åŒºåŸŸ --- */
    .search-wrapper {
      padding: 16px 24px;
      display: flex; gap: 10px;
      background: var(--bg-card);
    }

    #word { 
      flex: 1; 
      height: 44px; padding: 0 16px; 
      font-size: 16px; 
      border: 1px solid #D1D1D6; 
      border-radius: 10px; 
      background: #F2F2F7;
      transition: 0.2s;
    }
    #word:focus { background: #fff; border-color: var(--primary); }
    #word:disabled { opacity: 0.6; cursor: not-allowed; }

    #btnLookup {
      height: 44px; padding: 0 24px;
      font-size: 15px; font-weight: 600;
      border: none; border-radius: 10px;
      background-color: var(--primary); color: white;
      cursor: pointer; transition: 0.2s;
    }
    #btnLookup:active { transform: scale(0.96); }
    #btnLookup:disabled { background-color: #C7C7CC; cursor: not-allowed; opacity: 1; }

    /* --- ç»“æœå†…å®¹åŒº --- */
    #definition { 
      flex: 1; 
      overflow-y: auto; 
      padding: 24px; 
      line-height: 1.6; 
      font-size: 16px;
      -webkit-overflow-scrolling: touch;
    }

    /* --- è¯å…¸å†…å®¹é€šç”¨ç¾åŒ– --- */
    /* å³ä½¿æ²¡æœ‰ CSS æ–‡ä»¶ï¼Œè¿™äº›æ ·å¼èƒ½è®©å†…å®¹å˜å¥½çœ‹ */
    #definition b, #definition strong { color: var(--primary); font-weight: 700; }
    #definition i, #definition em { color: #FF2D55; font-style: italic; margin-right: 4px; }
    #definition a { color: var(--primary); text-decoration: none; border-bottom: 1px dashed rgba(0,122,255,0.3); }
    
    /* éšè—å¯èƒ½å¯¼è‡´è£‚å›¾çš„å…ƒç´  */
    #definition img { display: none !important; } 
    #definition a[href^="sound:"] { display: none !important; }
    
    /* ç©ºçŠ¶æ€æç¤º */
    .empty-hint {
        text-align: center; color: #C7C7CC; margin-top: 60px;
    }
  </style>
</head>
<body>

  <div class="app-card">
    <header>
        <h2>MDict Library</h2>
        <div id="status-area">â³ Connecting...</div>
    </header>

    <div class="search-wrapper">
        <input id="word" type="text" value="" placeholder="Loading dictionary..." disabled autocomplete="off">
        <input id="btnLookup" type="button" value="Search" disabled>
    </div>
    
    <div id="dict-title" style="display:none;"></div>
    
    <div id="definition">
        <div class="empty-hint">Type a word to start</div>
    </div>
  </div>

  <script src="require.js"></script>
  
  <script>
    // 1. é…ç½®
    require.config({
      baseUrl: '.',
      paths: {
        'jquery': 'jquery-1.11.3.min',
        'bluebird': 'bluebird.min',
        'lzo': 'minilzo-decompress.min',
        'ripemd128': 'ripemd128.min',
        'speex': 'speex.min'
      }
    });

    // 2. ä¸»é€»è¾‘
    require(['jquery', 'mdict-parser', 'mdict-renderer', 'bluebird'], function($, MdictParser, MdictRenderer, Promise) {
      
      const DICT_URL = 'dict.mdx'; // ğŸ‘ˆ ç¡®ä¿æ–‡ä»¶åæ­£ç¡®
      
      const $status = $('#status-area');
      const $input = $('#word');
      const $btn = $('#btnLookup');
      const $def = $('#definition');
      
      let mdictInstance = null;

      // --- è‡ªåŠ¨ä¸‹è½½ ---
      async function loadDictionary() {
        try {
          $status.html(`Downloading Data...`).removeClass('error success');
          
          const response = await fetch(DICT_URL);
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          
          const blob = await response.blob();
          const file = new File([blob], DICT_URL);
          
          $status.html('Parsing Index...');
          
          mdictInstance = new MdictParser([file]);
          await mdictInstance.parse();
          
          // åŠ è½½æˆåŠŸï¼šæ›´æ–° UI çŠ¶æ€
          $status.html(`Ready`).addClass('success');
          $input.prop('disabled', false).attr('placeholder', 'Type a word...');
          $btn.prop('disabled', false);
          $input.focus();

        } catch (err) {
          console.error(err);
          $status.html(`Failed to load`).addClass('error');
          $def.html(`<div style="text-align:center; padding:20px; color:red;">
            <strong>Error:</strong> ${err.message}<br>
            <small>Please check if <b>dict.mdx</b> exists.</small>
          </div>`);
        }
      }

      // --- æœç´¢ ---
      $btn.click(function() {
        const query = $input.val().trim();
        if (!query || !mdictInstance) return;
        
        $def.html('<div style="text-align:center; color:#999; margin-top:40px;">Searching...</div>');
        
        mdictInstance.lookup(query).then(function(result) {
          let html = result.definition;
          if (html) {
            html = html.replace(/href="entry:\/\//g, 'href="#');
            html = html.replace(/href="sound:\/\//g, 'href="#no-sound"');
            
            // æ¸²æŸ“ç»“æœ
            $def.html(html);
            
            // å†…éƒ¨é“¾æ¥ç‚¹å‡»å¤„ç†
            $def.find('a').on('click', function(e) {
                const href = $(this).attr('href');
                if (href && href.startsWith('#') && href !== '#no-sound') {
                    e.preventDefault();
                    const nextWord = href.substring(1).replace(/^[/\\]/, '');
                    if(nextWord) {
                        $input.val(nextWord);
                        $btn.click();
                    }
                }
            });
            
          } else {
            $def.html('<div style="text-align:center; margin-top:40px; color:#FF9500;">No definition found</div>');
          }
        }, function(err) {
          $def.html('<div style="color:red; text-align:center;">Search Error</div>');
        });
      });

      $input.keypress(function(e) {
        if(e.which == 13) $btn.click();
      });

      // å¯åŠ¨
      loadDictionary();
    });
  </script>
</body>
</html>
