<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="robots" content="noindex">
  <title>MDict Online Pro</title>
  
  <style>
    /* --- Ê†∑Âºè‰øùÊåÅ‰∏çÂèò --- */
    :root {
      --primary: #007AFF;
      --bg-body: #F5F5F7;
      --bg-card: #FFFFFF;
      --text-main: #1D1D1F;
      --text-sub: #86868B;
      --border: #E5E5EA;
      --radius: 18px;
      --shadow: 0 4px 20px rgba(0,0,0,0.06);
    }
    
    * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

    body { 
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, sans-serif; 
      background-color: var(--bg-body); 
      color: var(--text-main);
      margin: 0; padding: 20px; 
      display: flex; justify-content: center; min-height: 100vh;
    }

    .app-card {
      width: 100%; max-width: 680px;
      background: var(--bg-card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      display: flex; flex-direction: column;
      height: 90vh;
      overflow: hidden;
    }

    header {
      padding: 24px 24px 16px;
      text-align: center;
      border-bottom: 1px solid var(--border);
      background: rgba(255,255,255,0.9);
      backdrop-filter: blur(10px);
      z-index: 10;
    }

    h2 { margin: 0 0 12px 0; font-size: 18px; font-weight: 600; color: var(--text-main); }

    #status-area { 
      display: inline-block; padding: 6px 16px; background: #E5E5EA; color: var(--text-sub);
      border-radius: 20px; font-size: 13px; font-weight: 500; transition: 0.3s;
    }
    #status-area.success { background: #34C759; color: white; }
    #status-area.error { background: #FF3B30; color: white; }

    .progress-track { height: 4px; width: 100px; background: #E5E5EA; margin: 10px auto 0; border-radius: 2px; overflow: hidden; display: none; }
    .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.2s; }

    .search-wrapper { padding: 16px 24px; display: flex; gap: 10px; background: var(--bg-card); }

    #word { 
      flex: 1; height: 44px; padding: 0 16px; font-size: 16px; 
      border: 1px solid #D1D1D6; border-radius: 10px; background: #F2F2F7; transition: 0.2s;
    }
    #word:focus { background: #fff; border-color: var(--primary); }
    #word:disabled { opacity: 0.6; cursor: not-allowed; }

    #btnLookup {
      height: 44px; padding: 0 24px; font-size: 15px; font-weight: 600;
      border: none; border-radius: 10px; background-color: var(--primary); color: white;
      cursor: pointer; transition: 0.2s;
    }
    #btnLookup:active { transform: scale(0.96); }
    #btnLookup:disabled { background-color: #C7C7CC; cursor: not-allowed; opacity: 1; }

    #definition { flex: 1; overflow-y: auto; padding: 24px; line-height: 1.6; font-size: 16px; -webkit-overflow-scrolling: touch; }
    
    #definition b, #definition strong { color: var(--primary); font-weight: 700; }
    #definition i, #definition em { color: #FF2D55; font-style: italic; margin-right: 4px; }
    #definition a { color: var(--primary); text-decoration: none; border-bottom: 1px dashed rgba(0,122,255,0.3); }
    
    #definition img { max-width: 100%; height: auto; display: block; margin: 10px auto; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    #definition a[href^="sound:"] { display: none !important; }
    
    .empty-hint { text-align: center; color: #C7C7CC; margin-top: 60px; }
  </style>
</head>
<body>

  <div class="app-card">
    <header>
        <h2>MDict Library</h2>
        <div id="status-area">‚è≥ Initializing...</div>
        <div class="progress-track" id="p-track"><div class="progress-fill" id="p-fill"></div></div>
    </header>

    <div class="search-wrapper">
        <input id="word" type="text" value="" placeholder="Waiting for modules..." disabled autocomplete="off">
        <input id="btnLookup" type="button" value="Search" disabled>
    </div>
    
    <div id="dict-title" style="display:none;"></div>
    
    <div id="definition">
        <div class="empty-hint">Dictionary is loading...</div>
    </div>
  </div>

  <script src="require.js"></script>
  
  <script>
    // üî¥ 1. ÊâãÂä®ÂÆö‰πâÁº∫Â§±ÁöÑ XML Ëß£ÊûêÊ®°Âùó (ËøôÊòØ‰øÆÂ§ç scripterror ÁöÑÂÖ≥ÈîÆ)
    define('mdict-parseXml', function() {
        return function (str) {
            return (new DOMParser()).parseFromString(str, 'text/xml');
        }
    });

    // üî¥ 2. ÈÖçÁΩÆÂÖ∂‰ªñÊâÄÊúâÊñá‰ª∂ÁöÑË∑ØÂæÑ
    require.config({
      baseUrl: '.',
      paths: {
        'jquery': 'jquery-1.11.3.min',
        'bluebird': 'bluebird.min',
        'lzo': 'minilzo-decompress.min',
        'ripemd128': 'ripemd128.min',
        'speex': 'speex.min',
        'bitstring': 'bitstring.min',
        'pako': 'pako_inflate.min',
        'pcmdata': 'pcmdata.min',
        'murmurhash3': 'murmurhash3.min'
      }
    });

    // ÈîôËØØÊçïËé∑
    requirejs.onError = function (err) {
        console.error(err);
        const status = document.getElementById('status-area');
        const def = document.getElementById('definition');
        if (status) {
            status.innerHTML = 'System Error';
            status.className = 'error';
        }
        if (def) {
            def.innerHTML = `<div style="color:red; text-align:center; padding:20px;">
                <strong>Module Error:</strong> ${err.requireType}<br>
                Missing: <b>${err.requireModules}</b><br>
            </div>`;
        }
    };

    // 3. ‰∏ªÁ®ãÂ∫è
    require(['jquery', 'mdict-parser', 'mdict-renderer', 'bluebird'], function($, MdictParser, MdictRenderer, Promise) {
      
      const MDX_URL = 'dict.mdx';
      const MDD_URL = 'dict.mdd';
      
      const $status = $('#status-area');
      const $input = $('#word');
      const $btn = $('#btnLookup');
      const $def = $('#definition');
      const $pTrack = $('#p-track');
      const $pFill = $('#p-fill');
      
      let mdictInstance = null;

      function fetchFile(url, trackProgress) {
          return fetch(url).then(response => {
              if (!response.ok) throw new Error(`Failed to load ${url} (${response.status})`);
              
              if (!trackProgress) return response.blob(); 

              const contentLength = response.headers.get('content-length');
              const total = parseInt(contentLength, 10);
              let loaded = 0;
              const reader = response.body.getReader();
              const chunks = [];

              return new ReadableStream({
                  start(controller) {
                      function push() {
                          reader.read().then(({done, value}) => {
                              if (done) {
                                  controller.close();
                                  return;
                              }
                              loaded += value.length;
                              chunks.push(value);
                              if (total) {
                                  const pct = (loaded / total) * 100;
                                  $pFill.css('width', pct + '%');
                              }
                              controller.enqueue(value);
                              push();
                          });
                      }
                      push();
                  }
              }).then(() => new Blob(chunks));
          });
      }

      async function loadDictionary() {
        try {
          $status.html(`Downloading...`).removeClass('error success');
          $pTrack.show();
          
          const [blobMDX, blobMDD] = await Promise.all([
              fetchFile(MDX_URL, true), 
              fetchFile(MDD_URL, false)
          ]);
          
          const fileMDX = new File([blobMDX], MDX_URL);
          const fileMDD = new File([blobMDD], MDD_URL);
          
          $status.html('Parsing Index...');
          
          mdictInstance = new MdictParser([fileMDX, fileMDD]);
          await mdictInstance.parse();
          
          $status.html(`Ready`).addClass('success');
          $pTrack.fadeOut();
          $input.prop('disabled', false).attr('placeholder', 'Type a word...');
          $btn.prop('disabled', false);
          $input.focus();
          $('.empty-hint').text('Type a word to start');

        } catch (err) {
          console.error(err);
          $status.html(`Error`).addClass('error');
          $pTrack.hide();
          $def.html(`<div style="text-align:center; padding:20px; color:red;">
            <strong>Load Failed:</strong> ${err.message}<br>
            <small>Please check if <b>dict.mdx</b> exists.</small>
          </div>`);
        }
      }

      $btn.click(function() {
        const query = $input.val().trim();
        if (!query || !mdictInstance) return;
        
        $def.html('<div style="text-align:center; color:#999; margin-top:40px;">Searching...</div>');
        
        mdictInstance.lookup(query).then(function(result) {
          let html = result.definition;
          if (html) {
            html = html.replace(/href="entry:\/\//g, 'data-entry="'); 
            html = html.replace(/href="sound:\/\//g, 'href="#no-sound"');
            
            $def.html(html);
            
            $def.find('a[data-entry]').on('click', function(e) {
                e.preventDefault();
                const word = $(this).attr('data-entry').replace(/^[/\\]/, '').replace(/[/\\]$/, '');
                $input.val(word);
                $btn.click();
            });
            
          } else {
            $def.html('<div style="text-align:center; margin-top:40px; color:#FF9500;">No definition found</div>');
          }
        }, function(err) {
          $def.html('<div style="color:red; text-align:center;">Search Error</div>');
        });
      });

      $input.keypress(function(e) {
        if(e.which == 13) $btn.click();
      });

      loadDictionary();
    });
  </script>
</body>
</html>
