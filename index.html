<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="robots" content="noindex">
  <title>MDict Online Pro</title>
  
  <style>
    /* --- å…¨å±€é‡ç½® --- */
    :root {
      --primary: #007AFF;
      --bg-body: #F5F5F7;
      --bg-card: #FFFFFF;
      --text-main: #1D1D1F;
      --text-sub: #86868B;
      --border: #E5E5EA;
      --radius: 18px;
      --shadow: 0 4px 20px rgba(0,0,0,0.06);
    }
    
    * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

    body { 
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, sans-serif; 
      background-color: var(--bg-body); 
      color: var(--text-main);
      margin: 0; padding: 20px; 
      display: flex; justify-content: center; min-height: 100vh;
    }

    /* --- ä¸»å¡ç‰‡å®¹å™¨ --- */
    .app-card {
      width: 100%; max-width: 680px;
      background: var(--bg-card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      display: flex; flex-direction: column;
      height: 90vh; /* é€‚é…ç§»åŠ¨ç«¯ */
      overflow: hidden;
    }

    /* --- å¤´éƒ¨åŒºåŸŸ --- */
    header {
      padding: 24px 24px 16px;
      text-align: center;
      border-bottom: 1px solid var(--border);
      background: rgba(255,255,255,0.9);
      backdrop-filter: blur(10px);
      z-index: 10;
    }

    h2 { 
      margin: 0 0 12px 0; 
      font-size: 18px; 
      font-weight: 600; 
      color: var(--text-main); 
    }

    /* --- çŠ¶æ€èƒ¶å›Š --- */
    #status-area { 
      display: inline-block;
      padding: 6px 16px;
      background: #E5E5EA;
      color: var(--text-sub);
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
      transition: 0.3s;
    }
    #status-area.success { background: #34C759; color: white; }
    #status-area.error { background: #FF3B30; color: white; }

    /* --- æœç´¢åŒºåŸŸ --- */
    .search-wrapper {
      padding: 16px 24px;
      display: flex; gap: 10px;
      background: var(--bg-card);
    }

    #word { 
      flex: 1; 
      height: 44px; padding: 0 16px; 
      font-size: 16px; 
      border: 1px solid #D1D1D6; 
      border-radius: 10px; 
      background: #F2F2F7;
      transition: 0.2s;
    }
    #word:focus { background: #fff; border-color: var(--primary); }
    #word:disabled { opacity: 0.6; cursor: not-allowed; }

    #btnLookup {
      height: 44px; padding: 0 24px;
      font-size: 15px; font-weight: 600;
      border: none; border-radius: 10px;
      background-color: var(--primary); color: white;
      cursor: pointer; transition: 0.2s;
    }
    #btnLookup:active { transform: scale(0.96); }
    #btnLookup:disabled { background-color: #C7C7CC; cursor: not-allowed; opacity: 1; }

    /* --- ç»“æœå†…å®¹åŒº --- */
    #definition { 
      flex: 1; 
      overflow-y: auto; 
      padding: 24px; 
      line-height: 1.6; 
      font-size: 16px;
      -webkit-overflow-scrolling: touch;
    }

    /* --- è¯å…¸å†…å®¹ç¾åŒ– --- */
    #definition b, #definition strong { color: var(--primary); font-weight: 700; }
    #definition i, #definition em { color: #FF2D55; font-style: italic; margin-right: 4px; }
    #definition a { color: var(--primary); text-decoration: none; border-bottom: 1px dashed rgba(0,122,255,0.3); }
    
    /* ğŸŸ¢ å…³é”®ä¿®æ”¹ï¼šå…è®¸æ˜¾ç¤ºå›¾ç‰‡ */
    #definition img { 
        max-width: 100%; 
        height: auto; 
        display: block; 
        margin: 10px 0; 
        border-radius: 8px;
    } 
    /* éšè—å£°éŸ³é“¾æ¥ï¼ˆå› ä¸ºæ²¡æœ‰éŸ³é¢‘å¤„ç†é€»è¾‘ï¼Œä¸”å½±å“æ’ç‰ˆï¼‰ */
    #definition a[href^="sound:"] { display: none !important; }
    
    /* ç©ºçŠ¶æ€æç¤º */
    .empty-hint {
        text-align: center; color: #C7C7CC; margin-top: 60px;
    }
  </style>
</head>
<body>

  <div class="app-card">
    <header>
        <h2>MDict Library</h2>
        <div id="status-area">â³ Connecting...</div>
    </header>

    <div class="search-wrapper">
        <input id="word" type="text" value="" placeholder="Loading resources..." disabled autocomplete="off">
        <input id="btnLookup" type="button" value="Search" disabled>
    </div>
    
    <div id="dict-title" style="display:none;"></div>
    
    <div id="definition">
        <div class="empty-hint">Type a word to start</div>
    </div>
  </div>

  <script src="require.js"></script>
  
  <script>
    // 1. RequireJS é…ç½®
    require.config({
      baseUrl: '.',
      paths: {
        'jquery': 'jquery-1.11.3.min',
        'bluebird': 'bluebird.min',
        'lzo': 'minilzo-decompress.min',
        'ripemd128': 'ripemd128.min',
        'speex': 'speex.min'
      }
    });

    // 2. æ ¸å¿ƒé€»è¾‘
    require(['jquery', 'mdict-parser', 'mdict-renderer', 'bluebird'], function($, MdictParser, MdictRenderer, Promise) {
      
      // ğŸ”´ æ–‡ä»¶åé…ç½®åŒº (å¿…é¡»ä¸¥æ ¼ä¸€è‡´)
      const MDX_URL = 'dict.mdx';
      const MDD_URL = 'dict.mdd';
      
      const $status = $('#status-area');
      const $input = $('#word');
      const $btn = $('#btnLookup');
      const $def = $('#definition');
      
      let mdictInstance = null;

      // é€šç”¨ä¸‹è½½å‡½æ•° (æ”¯æŒè¿›åº¦)
      function fetchFile(url, onProgress) {
        return fetch(url).then(response => {
            if (!response.ok) throw new Error(`Download failed: ${url}`);
            
            const contentLength = response.headers.get('content-length');
            const total = parseInt(contentLength, 10);
            let loaded = 0;

            const reader = response.body.getReader();
            const chunks = [];

            return new ReadableStream({
                start(controller) {
                    function push() {
                        reader.read().then(({done, value}) => {
                            if (done) {
                                controller.close();
                                return;
                            }
                            loaded += value.length;
                            chunks.push(value);
                            if (onProgress && total) onProgress(loaded / total);
                            controller.enqueue(value);
                            push();
                        });
                    }
                    push();
                }
            }).then(() => new Blob(chunks));
        });
      }

      // --- æ ¸å¿ƒï¼šåŒæ–‡ä»¶è‡ªåŠ¨ä¸‹è½½ ---
      async function loadDictionary() {
        try {
            $status.html(`Downloading...`).removeClass('error success');
            
            // å¹¶è¡Œä¸‹è½½ï¼šMDXæœ‰è¿›åº¦æ¡ï¼ŒMDDé™é»˜ä¸‹è½½
            const [blobMDX, blobMDD] = await Promise.all([
                fetchFile(MDX_URL, (pct) => {
                    // åªæ˜¾ç¤º MDX çš„è¿›åº¦ï¼Œå› ä¸ºå®ƒæ˜¯ä¸»æ–‡ä»¶
                    $status.html(`Downloading... ${Math.round(pct * 100)}%`);
                }),
                fetchFile(MDD_URL)
            ]);

            $status.html('Parsing Index...');
            
            // æ„é€ æ–‡ä»¶å¯¹è±¡
            const fileMDX = new File([blobMDX], MDX_URL);
            const fileMDD = new File([blobMDD], MDD_URL);

            // è§£æ (ä¼ å…¥æ•°ç»„)
            mdictInstance = new MdictParser([fileMDX, fileMDD]);
            await mdictInstance.parse();
            
            // åŠ è½½æˆåŠŸ
            $status.html(`Ready`).addClass('success');
            $input.prop('disabled', false).attr('placeholder', 'Type a word...');
            $btn.prop('disabled', false);
            $input.focus();

        } catch (err) {
            console.error(err);
            $status.html(`Failed`).addClass('error');
            $def.html(`<div style="text-align:center; padding:20px; color:red;">
                <strong>Error:</strong> ${err.message}<br>
                <small>Ensure both <b>dict.mdx</b> and <b>dict.mdd</b> exist.</small>
            </div>`);
        }
      }

      // --- æœç´¢é€»è¾‘ ---
      $btn.click(function() {
        const query = $input.val().trim();
        if (!query || !mdictInstance) return;
        
        $def.html('<div style="text-align:center; color:#999; margin-top:40px;">Searching...</div>');
        
        mdictInstance.lookup(query).then(function(result) {
          let html = result.definition;
          if (html) {
            // æ¸…æ´—é“¾æ¥
            html = html.replace(/href="entry:\/\//g, 'href="#');
            html = html.replace(/href="sound:\/\//g, 'href="#no-sound"');
            
            // æ¸²æŸ“
            $def.html(html);
            
            // å¤„ç†å†…éƒ¨è·³è½¬
            $def.find('a').on('click', function(e) {
                const href = $(this).attr('href');
                if (href && href.startsWith('#') && href !== '#no-sound') {
                    e.preventDefault();
                    const nextWord = href.substring(1).replace(/^[/\\]/, '').replace(/[/\\]$/, '');
                    if(nextWord) {
                        $input.val(nextWord);
                        $btn.click();
                    }
                }
            });
            
          } else {
            $def.html('<div style="text-align:center; margin-top:40px; color:#FF9500;">No definition found</div>');
          }
        }, function(err) {
          $def.html('<div style="color:red; text-align:center;">Search Error</div>');
        });
      });

      $input.keypress(function(e) {
        if(e.which == 13) $btn.click();
      });

      // å¯åŠ¨
      loadDictionary();
    });
  </script>
</body>
</html>
