<!DOCTYPE html>
<meta name="robots" content="noindex">
<html>
<head>
  <meta name="description" content="MDict JS">
  <link rel="stylesheet" type="text/css" href="selectize.default.css">
  <meta charset="utf-8">
  <title>MDict JS Online</title>
  <style>
    #btnLookup {
      border: none;
      height: 36px;
      font-size: 12pt;
      font-weight: bold;
      vertical-align: top;
      border-radius: 3px;
      border-style: solid;
      border-width: 1px;
      border-color: transparent;
      padding: 0 2em;
      transition: background 400ms ease;
    }
    
    #btnLookup:not([disabled]) {
      background-color: #1A4FDD;
      color: white;
    }
    
    #dict-title {
      position: absolute;
      top: 0;
      right: 0;
      max-width: 300px;
      font-size: 10px;
      opacity: 0.9;
    }
    
    #dict-title * {
      font-size: 10px!important;
    }
    
    #word + .selectize-control {
      display: inline-block;
      min-width: 18em;
    }
    
    /*---------------------------*/     

    .stripes {
        background-color: #1A4FDD;
        color: white;
        border-color: #33D;
        -webkit-background-size: 30px 30px;
        -moz-background-size: 30px 30px;
        background-size: 30px 30px;           
        background-image: linear-gradient(135deg, rgba(255, 255, 255, 0.34) 25%, transparent 25%,
                            transparent 50%, rgba(255, 255, 255, 0.34) 50%, rgba(255, 255, 255, 0.34) 75%,
                            transparent 75%, transparent);         
        -webkit-animation: animate-stripes 1s linear infinite;
        -moz-animation: animate-stripes 1s linear infinite;    
        animation: animate-stripes 1s linear infinite;    
    }

    @keyframes animate-stripes { 
        0% {background-position: 0 0;} 100% {background-position: 60px 0;}
    }

    /* æ–°å¢è¿›åº¦æ¡æ ·å¼ */
    #loading-status {
        margin: 10px 0;
        padding: 10px;
        background: #f0f0f0;
        border-radius: 4px;
        font-size: 14px;
        color: #333;
    }
  </style>

</head>
<body>
  <div style="display:none;">
    Choose a dictionary file (*.mdx + optional *.mdd): <input id="dictfile" type="file" multiple>
  </div>
  
  <div id="loading-status">â³ Initializing...</div>

  <p>
  <input id="word" type="text" value="" placeholder="Type a word...">
  <input id="btnLookup" type="button" value="look up" disabled="true" class="">
  <p style="color: #888;font-size: 12px;font-style:italic;">
    You can apply wildcard in query text to narrow down word list of candidates:
    <ul style="color: #888;font-size: 12px;font-style:italic;">
      <li>"*" for 0 or more characters, "?" for just 1 character</li>
      <li>Append whitespace to end of query text to include space saperated phrase.</li>
    </ul>
  </p>
  
  <div id="dict-title"></div>
  <div id="definition">
  </div>
  
  <script type="text/javascript" src="conf.js"></script>
  
  <script src="require.js"></script>
  
  <script>
    // ğŸ”´ é…ç½®åŒºï¼šè¯·ä¿®æ”¹ä¸ºä½ çš„åœ¨çº¿ MDX æ–‡ä»¶å (å¿…é¡»åœ¨åŒä¸€ç›®å½•ä¸‹)
    var REMOTE_DICT_URL = 'dict.mdx'; 

    var $status = document.getElementById('loading-status');
    var $btn = document.getElementById('btnLookup');
    var $word = document.getElementById('word');

    // 1. é…ç½® RequireJS (å¤åˆ¶è‡ªåŸé¡¹ç›®å¯èƒ½éœ€è¦çš„é…ç½®ï¼Œç¡®ä¿è·¯å¾„æ­£ç¡®)
    require.config({
        baseUrl: '.',
        // å¦‚æœåŸé¡¹ç›®çš„ mdict.js ä¾èµ–è¿™äº›ï¼Œéœ€è¦ç¡®ä¿è·¯å¾„å¯¹
        paths: {
            'jquery': 'jquery-1.11.3.min', 
            // æ³¨æ„ï¼šè¿™é‡Œå‡è®¾ä½ æ–‡ä»¶å¤¹é‡Œæœ‰è¿™äº›æ–‡ä»¶ï¼Œå¦‚æœæ²¡æœ‰è¯·ä¿æŒåŸæ ·æˆ–è°ƒæ•´
        }
    });

    // 2. åŠ è½½ mdict æ¨¡å—
    // æ³¨æ„ï¼šåŸé¡¹ç›®çš„ mdict.js å¯èƒ½ä¼šè‡ªåŠ¨æ‰§è¡Œåˆå§‹åŒ–é€»è¾‘ã€‚
    // æˆ‘ä»¬éœ€è¦åœ¨å®ƒåˆå§‹åŒ–ä¹‹åï¼Œæ‰‹åŠ¨è§¦å‘â€œåŠ è½½æ–‡ä»¶â€çš„åŠ¨ä½œã€‚
    require(['mdict', 'jquery'], function(Mdict, $) {
        
        $status.innerHTML = "â¬‡ï¸ Downloading dictionary: " + REMOTE_DICT_URL;
        $btn.className = "stripes"; // åŠ è½½åŠ¨ç”»

        // 3. è‡ªåŠ¨ä¸‹è½½æ–‡ä»¶
        fetch(REMOTE_DICT_URL)
            .then(function(response) {
                if (!response.ok) throw new Error("Download failed: " + response.status);
                
                // è·å–æ–‡ä»¶å¤§å°ç”¨äºè¿›åº¦æ¡ï¼ˆå¦‚æœæœåŠ¡å™¨æ”¯æŒï¼‰
                var contentLength = response.headers.get('content-length');
                var total = parseInt(contentLength, 10);
                var loaded = 0;

                var reader = response.body.getReader();
                return new ReadableStream({
                    start: function(controller) {
                        function push() {
                            reader.read().then(function(result) {
                                if (result.done) {
                                    controller.close();
                                    return;
                                }
                                loaded += result.value.length;
                                if(total) {
                                    $status.innerHTML = "â¬‡ï¸ Downloading... " + Math.round(loaded/total*100) + "%";
                                }
                                controller.enqueue(result.value);
                                push();
                            });
                        }
                        push();
                    }
                });
            })
            .then(function(stream) {
                return new Response(stream).blob();
            })
            .then(function(blob) {
                // 4. å°† Blob è½¬æ¢ä¸º File å¯¹è±¡
                var file = new File([blob], REMOTE_DICT_URL);
                
                $status.innerHTML = "âš¡ Parsing dictionary...";

                // 5. æ ¸å¿ƒ hackï¼šè°ƒç”¨ mdict.js å†…éƒ¨å¯èƒ½æš´éœ²çš„åŠ è½½æ–¹æ³•
                // ç”±äºä¸çŸ¥é“ mdict.js çš„å…·ä½“æš´éœ²æ–¹å¼ï¼Œæˆ‘ä»¬å°è¯•æ¨¡æ‹Ÿ input çš„ change äº‹ä»¶
                // ä½†æ›´å¥½çš„æ–¹å¼æ˜¯ç›´æ¥åˆ©ç”¨ Mdict æ¨¡å—ï¼ˆå¦‚æœå®ƒæš´éœ²äº†ï¼‰
                
                // å°è¯•æ–¹æ¡ˆ Aï¼šå¦‚æœ Mdict æ¨¡å—å¯¼å‡ºäº† load å‡½æ•°
                /* if (typeof Mdict.load === 'function') {
                    Mdict.load([file]).then(onLoaded);
                } 
                */

                // å°è¯•æ–¹æ¡ˆ B (é€šç”¨)ï¼šåˆ©ç”¨ jQuery è§¦å‘äº‹ä»¶ï¼ˆè™½ç„¶ file input å¾ˆéš¾ç¼–ç¨‹èµ‹å€¼ï¼‰
                // file input æ˜¯åªè¯»çš„ï¼Œä¸èƒ½èµ‹å€¼ã€‚æ‰€ä»¥å¿…é¡»ç›´æ¥è°ƒç”¨å¤„ç†å‡½æ•°ã€‚
                
                // ã€å…³é”®å‡è®¾ã€‘ï¼šå‡è®¾ mdict.js ä¹Ÿæ˜¯ç”¨äº† mdict-parser ç­‰åº“
                // æˆ‘ä»¬ç›´æ¥åœ¨å…¨å±€èŒƒå›´æˆ–è€…é€šè¿‡ require è·å–åˆ°çš„å¯¹è±¡æ¥æ“ä½œ
                
                // æŸ¥çœ‹åŸ mdict.js æºç é€»è¾‘é€šå¸¸æ˜¯ï¼š
                // require(['mdict-parser', ...], function(Parser) { ... })
                
                // æ—¢ç„¶æˆ‘ä»¬æ— æ³•ä¿®æ”¹ mdict.jsï¼Œæˆ‘ä»¬å°è¯•é‡å†™ require çš„å›è°ƒé€»è¾‘
                // æˆ–è€…ï¼Œæˆ‘ä»¬ç›´æ¥åœ¨è¿™é‡Œé‡æ–°å†™ä¸€éåŠ è½½é€»è¾‘ï¼ˆè¦†ç›–åŸæœ‰çš„ input ç›‘å¬ï¼‰
                
                require(['mdict-parser', 'mdict-renderer'], function(MdictParser, MdictRenderer) {
                    // ä½¿ç”¨ Parser è§£æä¸‹è½½çš„æ–‡ä»¶
                    MdictParser([file]).then(function(resources) {
                        var mdict = resources[0];
                        
                        $status.innerHTML = "âœ… Ready! " + mdict.head.title;
                        $btn.className = "";
                        $btn.disabled = false;
                        $btn.value = "Look up";
                        
                        // è¦†ç›–ç‚¹å‡»äº‹ä»¶
                        $('#btnLookup').off('click').on('click', function() {
                            var query = $('#word').val();
                            mdict.lookup(query).then(function(definitions) {
                                var html = definitions.definition;
                                // æ¸²æŸ“
                                // è¿™é‡Œå¯èƒ½éœ€è¦ MdictRendererï¼Œæˆ–è€…ç›´æ¥æ˜¾ç¤º HTML
                                // åŸé¡¹ç›®å¯èƒ½æœ‰å¤æ‚çš„æ¸²æŸ“é€»è¾‘ï¼Œè¿™é‡Œç®€åŒ–å¤„ç†
                                $('#definition').html(html);
                                
                                // æ»šåŠ¨åˆ°é¡¶éƒ¨
                                window.scrollTo(0, 0);
                            });
                        });
                        
                        // ç»‘å®šå›è½¦
                        $('#word').off('keypress').on('keypress', function(e) {
                            if(e.which == 13) $('#btnLookup').click();
                        });

                    });
                });
                
            })
            .catch(function(err) {
                console.error(err);
                $status.innerHTML = "âŒ Error: " + err.message;
                $btn.className = "";
            });
    });
  </script>
</body>
</html>
